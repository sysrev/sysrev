#!/bin/bash
set -eu

# read version string from text file (git)
version_txt () {
  cat .clj-kondo/version.txt
}

# read version string from clj-kondo executable
version_bin () {
  if [ -e "scripts/clj-kondo" ] ; then
    (./scripts/clj-kondo --version || echo) | sed 's/.*v//g'
  fi
}

# check if ./scripts/clj-kondo exists and version matches version.txt
clj_kondo_installed () {
  if [ "$(version_bin)" == "$(version_txt)" ] ; then
    echo "$(version_txt)"
  fi
}

# (re)install ./scripts/clj-kondo if not found or wrong version
if [ -z "$(clj_kondo_installed)" ] ; then
  echo -n "Installing clj-kondo [ ./scripts/clj-kondo ] ... "
  ./scripts/install-clj-kondo > /dev/null || (echo "failed" && false)
  echo "done"
  ./scripts/clj-kondo --version
fi

# run linter
./scripts/clj-kondo --lint bases/ components/ projects/ src/ test/ "$@" ||
  (set -eu
   echo
   echo "!! fix linter warnings or"
   echo "!! (1) wrap offending form in #_{:clj-kondo/ignore [...]} "
   echo "!! (2) update .clj-kondo/config.edn"
   echo
   exit 1)
