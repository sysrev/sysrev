(ns sysrev.shared.predictions)

#_{:clj-kondo/ignore [:clojure-lsp/unused-public-var :unused-binding]}
(defprotocol ClassificationMetrics
  (true-positives [this])
  (true-negatives [this])
  (false-positives [this])
  (false-negatives [this])
  (condition-positives [this])
  (condition-negatives [this])
  (examples [this])
  (true-predictions [this])
  (false-predictions [this])
  (true-positive-rate [this])
  (true-negative-rate [this])
  (false-positive-rate [this])
  (false-negative-rate [this])
  (predicted-positives [this])
  (predicted-negatives [this])
  (positive-predictive-value [this])
  (negative-predictive-value [this])
  (false-discovery-rate [this])
  (false-ignorance-rate [this])
  (accuracy [this])
  (true-accuracy [this])
  (false-accuracy [this])
  (balanced-accuracy [this]))

#_{:clj-kondo/ignore [:clojure-lsp/unused-public-var :unused-binding]}
(defrecord AccuracyMetric [true-positives true-negatives false-positives false-negatives]
  ClassificationMetrics
  (true-positives [this] true-positives)
  (true-negatives [this] true-negatives)
  (false-positives [this] false-positives)
  (false-negatives [this] false-negatives)
  (condition-positives [this] (+ true-positives false-negatives))
  (condition-negatives [this] (+ true-negatives false-positives))
  (examples [this] (+ (condition-positives this) (condition-negatives this)))
  (true-predictions [this] (+ true-positives true-negatives))
  (false-predictions [this] (+ false-positives false-negatives))
  (true-positive-rate [this] (/ true-positives (condition-positives this)))
  (true-negative-rate [this] (/ true-negatives (condition-negatives this)))
  (false-positive-rate [this] (/ false-positives (condition-negatives this)))
  (false-negative-rate [this] (/ false-negatives (condition-positives this)))
  (predicted-positives [this] (+ true-positives false-positives))
  (predicted-negatives [this] (+ true-negatives false-negatives))
  (positive-predictive-value [this] (/ true-positives (predicted-positives this)))
  (negative-predictive-value [this] (/ true-negatives (predicted-negatives this)))
  (false-discovery-rate [this] (/ false-positives (predicted-positives this)))
  (false-ignorance-rate [this] (/ false-negatives (predicted-negatives this)))
  (accuracy [this] (/ (true-predictions this) (examples this)))
  (true-accuracy [this] (/ true-positives (condition-positives this)))
  (false-accuracy [this] (/ true-negatives (condition-negatives this)))
  (balanced-accuracy [this] (->> 2.0 (/ (+ (true-accuracy this) (false-accuracy this))))))
